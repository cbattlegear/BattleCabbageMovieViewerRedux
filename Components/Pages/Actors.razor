@page "/actors"
@using BattleCabbageMovieViewer.Models
@using BattleCabbageMovieViewer.Services
@inject IMovieApiService MovieApi
@inject IJSRuntime JSRuntime
@rendermode InteractiveServer

<PageTitle>Actors - Battle Cabbage</PageTitle>

<div class="max-w-7xl mx-auto px-4 md:px-6 lg:px-8 py-8">
    <!-- Page Header -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-8">
        <h1 class="text-3xl md:text-4xl font-bold text-theme-primary flex items-center gap-3">
            <LucideIcon Name="users" Class="w-8 h-8 text-gold" />
            Actors
        </h1>

        <!-- View Toggle -->
        <div class="flex items-center gap-2">
            <button class="p-2 rounded-lg transition-colors @(_viewMode == ViewMode.Grid ? "bg-gold text-black" : "bg-theme-tertiary text-theme-secondary hover:text-theme-primary")"
                    @onclick="() => _viewMode = ViewMode.Grid"
                    title="Grid view">
                <LucideIcon Name="grid-3x3" Class="w-5 h-5" />
            </button>
            <button class="p-2 rounded-lg transition-colors @(_viewMode == ViewMode.Table ? "bg-gold text-black" : "bg-theme-tertiary text-theme-secondary hover:text-theme-primary")"
                    @onclick="() => _viewMode = ViewMode.Table"
                    title="Table view">
                <LucideIcon Name="table" Class="w-5 h-5" />
            </button>
        </div>
    </div>

    <!-- Search Filter -->
    <div class="mb-6">
        <div class="grid-search-wrapper">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/>
            </svg>
            <input type="text"
                   class="grid-filter-input"
                   placeholder="Search actors by name..."
                   value="@_searchFilter"
                   @oninput="OnSearchInput" />
        </div>
    </div>

    @if (_isLoading)
    {
        <div class="flex items-center justify-center py-20">
            <div class="flex flex-col items-center gap-4">
                <div class="spinner"></div>
                <p class="text-theme-secondary">Loading actors...</p>
            </div>
        </div>
    }
    else if (_viewMode == ViewMode.Grid)
    {
        <!-- Actors Grid -->
        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4">
            @foreach (var actor in FilteredActors)
            {
                <div class="card p-4 flex flex-col items-center text-center cursor-pointer hover:ring-2 hover:ring-gold transition-all @(_selectedActorId == actor.ActorId ? "ring-2 ring-gold" : "")"
                     @onclick="() => ToggleActorMovies(actor)">
                    @if (!string.IsNullOrEmpty(actor.ImageUrl))
                    {
                        <img src="@actor.ImageUrl" alt="@actor.Actor" class="w-16 h-16 rounded-full object-cover mb-3" />
                    }
                    else
                    {
                        <div class="w-16 h-16 rounded-full bg-theme-tertiary flex items-center justify-center mb-3">
                            <LucideIcon Name="user" Class="w-8 h-8 text-theme-secondary" />
                        </div>
                    }
                    <span class="text-theme-primary font-medium text-sm line-clamp-2">
                        @actor.Actor
                    </span>
                </div>
            }
        </div>

        <!-- Selected Actor Movies -->
        @if (_selectedActorId.HasValue)
        {
            <div class="mt-6 card p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold text-theme-primary flex items-center gap-2">
                        <LucideIcon Name="film" Class="w-5 h-5 text-gold" />
                        Movies featuring @_selectedActorName
                    </h2>
                    <button class="p-1 rounded hover:bg-theme-tertiary text-theme-secondary" @onclick="CloseActorMovies">
                        <LucideIcon Name="x" Class="w-5 h-5" />
                    </button>
                </div>
                @if (_isLoadingMovies)
                {
                    <div class="flex items-center gap-3 py-4">
                        <div class="spinner"></div>
                        <span class="text-theme-secondary">Loading movies...</span>
                    </div>
                }
                else if (_actorMovies.Any())
                {
                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                        @foreach (var movie in _actorMovies)
                        {
                            <div class="card p-3 flex gap-3">
                                @if (movie.FullPosterUrl != null)
                                {
                                    <img src="@movie.FullPosterUrl" alt="@movie.Title" class="w-12 h-[4.5rem] rounded object-cover flex-shrink-0" />
                                }
                                <div class="min-w-0">
                                    <p class="text-theme-primary font-medium text-sm line-clamp-2">@movie.Title</p>
                                    @if (movie.ReleaseDate.HasValue)
                                    {
                                        <p class="text-theme-secondary text-xs mt-1">@movie.ReleaseDate.Value.Year</p>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <p class="text-theme-secondary py-4">No movies found for this actor.</p>
                }
            </div>
        }

        @if (!FilteredActors.Any())
        {
            <div class="flex flex-col items-center justify-center py-20 text-theme-tertiary">
                <LucideIcon Name="search-x" Class="w-12 h-12 mb-4" />
                <p>No actors found matching your search.</p>
            </div>
        }

        <!-- Pagination -->
        <div class="flex justify-center items-center gap-3 mt-10">
            <button type="button" class="btn-ghost @(_currentPage == 1 ? "opacity-50 cursor-not-allowed" : "")"
                    @onclick="@(async () => await PreviousPage())"
                    disabled="@(_currentPage == 1)">
                <LucideIcon Name="chevron-left" Class="w-5 h-5 mr-1" />
                Previous
            </button>
            <span class="px-5 py-2.5 bg-gold text-black rounded-lg font-semibold">
                Page @_currentPage
            </span>
            <button type="button" class="btn-ghost @(!_hasMore ? "opacity-50 cursor-not-allowed" : "")"
                    @onclick="@(async () => await NextPage())"
                    disabled="@(!_hasMore)">
                Next
                <LucideIcon Name="chevron-right" Class="w-5 h-5 ml-1" />
            </button>
        </div>
    }
    else
    {
        <!-- Actors Table View with QuickGrid -->
        <div class="quickgrid-wrapper">
            <QuickGrid Items="@FilteredActors.AsQueryable()" Class="quickgrid">
                <TemplateColumn Title="" Class="w-16">
                    @if (!string.IsNullOrEmpty(context.ImageUrl))
                    {
                        <img src="@context.ImageUrl" alt="@context.Actor" class="w-10 h-10 rounded-full object-cover" />
                    }
                    else
                    {
                        <div class="w-10 h-10 rounded-full bg-theme-tertiary flex items-center justify-center">
                            <LucideIcon Name="user" Class="w-5 h-5 text-theme-secondary" />
                        </div>
                    }
                </TemplateColumn>
                <TemplateColumn Title="Name" Sortable="true" SortBy="@(GridSort<ActorResponse>.ByAscending(a => a.Actor))">
                    <button class="text-left hover:text-gold transition-colors" @onclick="() => ToggleActorMovies(context)">
                        @context.Actor
                    </button>
                </TemplateColumn>
                <PropertyColumn Property="@(a => a.ActorId)" Title="ID" Sortable="true" />
            </QuickGrid>
        </div>

        @if (!FilteredActors.Any())
        {
            <div class="flex flex-col items-center justify-center py-20 text-theme-tertiary">
                <LucideIcon Name="search-x" Class="w-12 h-12 mb-4" />
                <p>No actors found matching your search.</p>
            </div>
        }

        <!-- Pagination -->
        <div class="flex justify-center items-center gap-3 mt-10">
            <button type="button" class="btn-ghost @(_currentPage == 1 ? "opacity-50 cursor-not-allowed" : "")"
                    @onclick="@(async () => await PreviousPage())"
                    disabled="@(_currentPage == 1)">
                <LucideIcon Name="chevron-left" Class="w-5 h-5 mr-1" />
                Previous
            </button>
            <span class="px-5 py-2.5 bg-gold text-black rounded-lg font-semibold">
                Page @_currentPage
            </span>
            <button type="button" class="btn-ghost @(!_hasMore ? "opacity-50 cursor-not-allowed" : "")"
                    @onclick="@(async () => await NextPage())"
                    disabled="@(!_hasMore)">
                Next
                <LucideIcon Name="chevron-right" Class="w-5 h-5 ml-1" />
            </button>
        </div>
    }
</div>

@code {
    private List<ActorResponse> _actors = [];
    private bool _isLoading = true;
    private int _currentPage = 1;
    private const int PageSize = 50;
    private bool _hasMore = true;
    private string _searchFilter = "";
    private ViewMode _viewMode = ViewMode.Grid;
    private int? _selectedActorId;
    private string? _selectedActorName;
    private List<MovieResponse> _actorMovies = [];
    private bool _isLoadingMovies;

    private enum ViewMode { Grid, Table }

    private IEnumerable<ActorResponse> FilteredActors => string.IsNullOrWhiteSpace(_searchFilter)
        ? _actors
        : _actors.Where(a => a.Actor.Contains(_searchFilter, StringComparison.OrdinalIgnoreCase));

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
    }

    private async Task LoadData()
    {
        _isLoading = true;
        try
        {
            var skip = (_currentPage - 1) * PageSize;
            _actors = await MovieApi.GetActorsAsync(skip, PageSize + 1);
            _hasMore = _actors.Count > PageSize;
            if (_hasMore)
            {
                _actors = _actors.Take(PageSize).ToList();
            }
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task PreviousPage()
    {
        if (_currentPage > 1)
        {
            _currentPage--;
            await LoadData();
        }
    }

    private async Task NextPage()
    {
        if (_hasMore)
        {
            _currentPage++;
            await LoadData();
        }
    }

    private void OnSearchInput(ChangeEventArgs e)
    {
        _searchFilter = e.Value?.ToString() ?? "";
        StateHasChanged();
    }

    private async Task ToggleActorMovies(ActorResponse actor)
    {
        if (_selectedActorId == actor.ActorId)
        {
            CloseActorMovies();
            return;
        }

        _selectedActorId = actor.ActorId;
        _selectedActorName = actor.Actor;
        _isLoadingMovies = true;
        _actorMovies = [];
        StateHasChanged();

        _actorMovies = await MovieApi.GetActorMoviesAsync(actor.ActorId);
        _isLoadingMovies = false;
    }

    private void CloseActorMovies()
    {
        _selectedActorId = null;
        _selectedActorName = null;
        _actorMovies = [];
    }
}
