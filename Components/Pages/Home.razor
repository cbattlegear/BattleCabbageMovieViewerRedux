@page "/"
@using BattleCabbageMovieViewer.Models
@using BattleCabbageMovieViewer.Services
@inject IMovieApiService MovieApi
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@rendermode InteractiveServer

<PageTitle>Battle Cabbage Movies</PageTitle>

@if (_isLoading)
{
    <div class="min-h-screen flex items-center justify-center">
        <div class="flex flex-col items-center gap-4">
            <div class="spinner"></div>
            <p class="text-theme-secondary">Loading movies...</p>
        </div>
    </div>
}
else
{
    <!-- Hero Section - Featured Movie -->
    @if (_randomMovies.Count > 0)
    {
        <HeroSection Movie="_randomMovies[0]" />
    }

    <!-- Content Rows -->
    <div class="py-8 space-y-2">
        <!-- Featured Movies Row -->
        @if (_randomMovies.Count > 0)
        {
            <ContentRow Title="Featured Movies" Icon="sparkles">
                @foreach (var movie in _randomMovies)
                {
                    <div class="content-row-item w-44 sm:w-52 md:w-56 lg:w-60">
                        <MoviePosterCard Movie="movie" />
                    </div>
                }
            </ContentRow>
        }

        <!-- Top Rated Row -->
        @if (_topRatedMovies.Count > 0)
        {
            <ContentRow Title="Top Rated" Icon="trophy" ViewAllHref="/movies">
                @foreach (var movie in _topRatedMovies)
                {
                    <div class="content-row-item w-44 sm:w-52 md:w-56 lg:w-60">
                        <MoviePosterCard Movie="movie" />
                    </div>
                }
            </ContentRow>
        }

        <!-- Recent Movies Row -->
        @if (_recentMovies.Count > 0)
        {
            <ContentRow Title="Recently Added" Icon="clock" ViewAllHref="/movies">
                @foreach (var movie in _recentMovies)
                {
                    <div class="content-row-item w-44 sm:w-52 md:w-56 lg:w-60">
                        <MoviePosterCard Movie="movie" />
                    </div>
                }
            </ContentRow>
        }

        <!-- Browse by Genre Section -->
        @if (_topGenres.Count > 0)
        {
            <section class="max-w-7xl mx-auto px-4 md:px-6 lg:px-8 py-6">
                <h2 class="section-title mb-6">
                    <LucideIcon Name="layers" Class="w-6 h-6 text-gold" />
                    Browse by Genre
                </h2>
                <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-3">
                    @foreach (var genre in _topGenres)
                    {
                        <a href="/movies?genre=@Uri.EscapeDataString(genre.Genre)"
                           class="card card-hover p-4 text-center group">
                            <span class="text-theme-primary group-hover:text-gold font-medium transition-colors">@genre.Genre</span>
                            <span class="block text-sm text-theme-tertiary mt-1">@genre.MovieCount movies</span>
                        </a>
                    }
                </div>
            </section>
        }

        <!-- Worst Rated (fun section) -->
        @if (_worstRatedMovies.Count > 0)
        {
            <ContentRow Title="So Bad They're Good?" Icon="skull">
                @foreach (var movie in _worstRatedMovies)
                {
                    <div class="content-row-item w-44 sm:w-52 md:w-56 lg:w-60">
                        <MoviePosterCard Movie="movie" />
                    </div>
                }
            </ContentRow>
        }

        <!-- Top Actors & Directors Section -->
        <section class="max-w-7xl mx-auto px-4 md:px-6 lg:px-8 py-6">
            <div class="grid sm:grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Top Actors -->
                @if (_topActors.Count > 0)
                {
                    <div class="card p-6">
                        <h3 class="section-title mb-4">
                            <LucideIcon Name="users" Class="w-5 h-5 text-gold" />
                            Top Actors
                        </h3>
                        <div class="space-y-3">
                            @foreach (var actor in _topActors.Take(5))
                            {
                                <a href="/actors/@actor.ActorId" class="flex items-center gap-3 p-2 rounded-lg hover:bg-theme-tertiary transition-colors no-underline">
                                    @if (!string.IsNullOrEmpty(actor.FullImageUrl))
                                    {
                                        <img src="@actor.FullImageUrl" alt="@actor.Actor" class="w-10 h-10 rounded-full object-cover flex-shrink-0" onerror="this.style.display='none';this.nextElementSibling.style.display='flex'" />
                                        <div class="w-10 h-10 rounded-full bg-theme-tertiary items-center justify-center flex-shrink-0" style="display:none">
                                            <LucideIcon Name="user" Class="w-5 h-5 text-theme-secondary" />
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="w-10 h-10 rounded-full bg-theme-tertiary flex items-center justify-center flex-shrink-0">
                                            <LucideIcon Name="user" Class="w-5 h-5 text-theme-secondary" />
                                        </div>
                                    }
                                    <div class="flex-1 min-w-0">
                                        <span class="text-theme-primary font-medium block truncate">@actor.Actor</span>
                                        <span class="text-sm text-theme-tertiary">@actor.MovieCount movies</span>
                                    </div>
                                </a>
                            }
                        </div>
                    </div>
                }

                <!-- Top Directors -->
                @if (_topDirectors.Count > 0)
                {
                    <div class="card p-6">
                        <h3 class="section-title mb-4">
                            <LucideIcon Name="video" Class="w-5 h-5 text-gold" />
                            Top Directors
                        </h3>
                        <div class="space-y-3">
                            @foreach (var director in _topDirectors.Take(5))
                            {
                                <a href="/directors/@director.DirectorId" class="flex items-center gap-3 p-2 rounded-lg hover:bg-theme-tertiary transition-colors no-underline">
                                    @if (!string.IsNullOrEmpty(director.FullImageUrl))
                                    {
                                        <img src="@director.FullImageUrl" alt="@director.Director" class="w-10 h-10 rounded-full object-cover flex-shrink-0" onerror="this.style.display='none';this.nextElementSibling.style.display='flex'" />
                                        <div class="w-10 h-10 rounded-full bg-theme-tertiary items-center justify-center flex-shrink-0" style="display:none">
                                            <LucideIcon Name="clapperboard" Class="w-5 h-5 text-theme-secondary" />
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="w-10 h-10 rounded-full bg-theme-tertiary flex items-center justify-center flex-shrink-0">
                                            <LucideIcon Name="clapperboard" Class="w-5 h-5 text-theme-secondary" />
                                        </div>
                                    }
                                    <div class="flex-1 min-w-0">
                                        <span class="text-theme-primary font-medium block truncate">@director.Director</span>
                                        <span class="text-sm text-theme-tertiary">@director.MovieCount movies</span>
                                    </div>
                                </a>
                            }
                        </div>
                    </div>
                }
            </div>
        </section>
    </div>
}

@code {
    private bool _isLoading = true;
    private List<MovieResponse> _randomMovies = [];
    private List<MovieResponse> _topRatedMovies = [];
    private List<MovieResponse> _worstRatedMovies = [];
    private List<MovieResponse> _recentMovies = [];
    private List<TopGenreResponse> _topGenres = [];
    private List<TopActorResponse> _topActors = [];
    private List<TopDirectorResponse> _topDirectors = [];

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Load all data in parallel for better performance
            var randomTask = MovieApi.GetRandomMoviesAsync();
            var topRatedTask = MovieApi.GetTopRatedMoviesAsync();
            var worstRatedTask = MovieApi.GetWorstRatedMoviesAsync();
            var recentTask = MovieApi.GetRecentMoviesAsync();
            var topGenresTask = MovieApi.GetTopGenresAsync();
            var topActorsTask = MovieApi.GetTopActorsAsync();
            var topDirectorsTask = MovieApi.GetTopDirectorsAsync();

            await Task.WhenAll(randomTask, topRatedTask, worstRatedTask, recentTask,
                topGenresTask, topActorsTask, topDirectorsTask);

            _randomMovies = await randomTask;
            _topRatedMovies = await topRatedTask;
            _worstRatedMovies = await worstRatedTask;
            _recentMovies = await recentTask;
            _topGenres = await topGenresTask;
            _topActors = await topActorsTask;
            _topDirectors = await topDirectorsTask;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading home page data: {ex.Message}");
        }
        finally
        {
            _isLoading = false;
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
    }

}
